# 云服务器训练部署指南

## 📦 文件清单

**总大小**: 3.89 GB

### 必需文件
- `data.yaml` - 数据集配置文件
- `train_yolo11n.py` - 训练脚本
- `train/` - 训练集 (54,624 张图片)
  - `images/` - 训练图片
  - `labels/` - 训练标签
- `valid/` - 验证集 (6,824 张图片)
  - `images/` - 验证图片
  - `labels/` - 验证标签
- `test/` - 测试集 (6,836 张图片)
  - `images/` - 测试图片
  - `labels/` - 测试标签

---

## 🚀 快速部署步骤

### 1. 在本地打包（Windows PowerShell）

```powershell
# 进入数据集目录
cd "d:\archive (1)\9 Facial Expressions you need - resplit"

# 创建压缩包（约需5-10分钟）
Compress-Archive -Path data.yaml,train_yolo11n.py,train,valid,test -DestinationPath ..\facial_expression_dataset.zip -Force
```

或者使用 7-Zip（更快更小）:
```powershell
7z a -tzip ..\facial_expression_dataset.zip data.yaml train_yolo11n.py train valid test
```

### 2. 上传到云服务器

**方法A - 使用 SCP**:
```bash
scp facial_expression_dataset.zip user@server_ip:/home/user/
```

**方法B - 使用云服务商的网页上传工具**

**方法C - 使用云存储中转**:
- 上传到阿里云OSS/腾讯云COS/AWS S3
- 在云服务器下载

### 3. 在云服务器解压和配置

```bash
# 解压文件
unzip facial_expression_dataset.zip -d facial_expression_dataset/
cd facial_expression_dataset/

# 检查文件结构
ls -la

# 应该看到:
# data.yaml
# train_yolo11n.py
# train/
# valid/
# test/
```

### 4. 安装依赖

```bash
# 安装 Ultralytics YOLO
pip install ultralytics

# 或使用清华镜像加速
pip install ultralytics -i https://pypi.tuna.tsinghua.edu.cn/simple
```

### 5. 开始训练

```bash
# 直接运行
python train_yolo11n.py

# 或使用 nohup 后台运行
nohup python train_yolo11n.py > training.log 2>&1 &

# 查看训练日志
tail -f training.log
```

---

## ⚙️ 配置说明

### 硬件配置 (已针对您的实例优化)
- **GPU**: RTX PRO 6000 (1卡)
- **CPU**: 22核心
- **内存**: 110GB
- **磁盘**: 30GB系统盘 + 50GB数据盘

### 💾 磁盘使用建议 (重要!)
您的系统盘只有 30GB，建议将数据集和训练输出放在 **50GB 数据盘** 上，以防空间不足。

1. **查找数据盘**:
   ```bash
   df -h
   # 通常挂载在 /root/autodl-tmp, /mnt/data, 或 /data
   ```

2. **在数据盘工作**:
   ```bash
   # 假设数据盘在 /root/autodl-tmp
   cd /root/autodl-tmp
   
   # 上传并解压到这里
   unzip ~/facial_expression_dataset.zip -d dataset/
   cd dataset/
   ```

### 训练参数 (高性能 & 防崩溃版)
- **图像尺寸**: 640×640
- **Batch Size**: 128 (充分利用 RTX 6000 显存)
- **Workers**: 8 (利用 SSD 高速读取)
- **Cache**: False (关键! 不占用 RAM，直接从 SSD 读取)
- **Half**: True (半精度加速)
- **预计时间**: 4-5小时

### 早停机制
- 如果验证集性能连续20轮不提升，自动停止
- 通常在60-80轮达到最佳效果
- 可节省30-40%训练时间

---

## 📊 训练监控

### 查看训练进度
```bash
# 实时查看日志
tail -f training.log

# 或者查看最后100行
tail -n 100 training.log
```

### 查看GPU使用情况
```bash
# 实时监控
nvidia-smi -l 1

# 或者
watch -n 1 nvidia-smi
```

### 中断和恢复训练

**中断训练**:
- 按 `Ctrl+C` 或结束进程
- 权重自动保存到 `facial_expression_yolo11n/exp/weights/last.pt`

**恢复训练**:
- 直接再次运行 `python train_yolo11n.py`
- 脚本会自动检测并从上次中断处继续

---

## 📁 训练结果

训练完成后，结果保存在:

```
facial_expression_yolo11n/exp/
├── weights/
│   ├── best.pt          # 最佳模型权重
│   └── last.pt          # 最后一轮权重
├── results.csv          # 训练指标
├── results.png          # 训练曲线图
├── confusion_matrix.png # 混淆矩阵
└── val_batch*_pred.jpg  # 验证集预测示例
```

---

## 💰 成本优化建议

1. **使用按量计费**: 训练约4-5小时，按需使用
2. **及时关机**: 训练完成后立即关闭实例
3. **监控早停**: 关注 `patience` 机制，避免过度训练
4. **下载结果**: 训练完成后立即下载权重文件

---

## 🔧 常见问题

### 1. CUDA Out of Memory
```python
# 修改 train_yolo11n.py 中的 batch size
'batch': 64,  # 从80降到64
```

### 2. 数据加载慢
```python
# 减少 workers
'workers': 12,  # 从22降到12
```

### 3. 训练速度慢
- 检查GPU使用率: `nvidia-smi`
- 确保使用GPU: `'device': 0`

### 4. 继续训练不工作
- 检查是否存在: `facial_expression_yolo11n/exp/weights/last.pt`
- 手动指定: `model = YOLO('path/to/last.pt')`

---

## 📥 下载训练结果

```bash
# 在云服务器打包结果
cd facial_expression_dataset/
zip -r training_results.zip facial_expression_yolo11n/

# 从本地下载（在本地执行）
scp user@server_ip:/home/user/facial_expression_dataset/training_results.zip .
```

---

## ✅ 检查清单

上传前:
- [ ] 已修改 `train_yolo11n.py` 使用相对路径
- [ ] 已修改 `data.yaml` 使用相对路径  
- [ ] 已打包所有必需文件
- [ ] 压缩包大小约 1-2 GB (压缩后)

云服务器上:
- [ ] 已解压文件
- [ ] 已安装 ultralytics
- [ ] 已验证 GPU 可用 (`nvidia-smi`)
- [ ] 已检查文件结构
- [ ] 准备开始训练

训练后:
- [ ] 下载 best.pt 权重文件
- [ ] 下载训练结果和图表
- [ ] 关闭云服务器实例
